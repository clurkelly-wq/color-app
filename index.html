<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Color Coherence Lamp — MindLamp</title>
  <meta name="theme-color" content="#38bdf8"/>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#121936; --ink:#eaf2ff; --muted:#9bb0d7; --accent:#38bdf8; --border:#263259;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px 16px 44px}
    header{padding:10px 0 16px;text-align:center}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    button{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border:none;color:#00111a;border-radius:12px;
      padding:12px 18px;font-weight:800;cursor:pointer;font-size:16px}
    button.ghost{background:#0f1735;color:#cfe3ff;border:1px solid var(--border)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .lamp{width:100%;aspect-ratio: 3/2;border-radius:18px;border:1px solid var(--border);
      background:#0a1025;box-shadow:0 20px 80px rgba(0,0,0,.35) inset, 0 10px 30px rgba(56,189,248,.18);
      transition: background 200ms ease, box-shadow 200ms ease, transform 160ms ease}
    .lamp:hover{transform: translateY(-1px)}
    .rowinfo{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:12px}
    .pill{display:inline-block;border:1px solid var(--border);background:#0f1735;color:#cfe3ff;
      padding:8px 12px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted);font-size:12px;text-align:center;margin-top:10px}
    .ctl{display:flex;gap:12px;row-gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:14px 0}
    select,input[type="range"]{background:#0e1020;border:1px solid var(--border);color:#e8ecff;border-radius:10px;padding:8px 10px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0f1735;color:#cfe3ff;font-size:12px}
    .dot{width:12px;height:12px;border-radius:999px;border:1px solid var(--border)}
    .fsWrap{position:relative}
    .fsBtn{position:absolute;right:12px;top:12px}
    .targets{display:flex;gap:8px;row-gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:12px 0}
    .target{cursor:pointer; padding:8px 10px; border-radius:12px; border:1px solid var(--border); background:#0f1735; color:#cfe3ff; font-size:12px}
    .target.active{outline:2px solid #38bdf8}
    .settingsToggle{display:flex;justify-content:center;margin-top:12px}
    .settingsPanel{display:none}
    /* Mobile spacing adjustments */
    @media (max-width: 600px){
      .wrap{padding:16px 12px 36px}
      .ctl, .targets, .row{gap:10px}
      .pill{font-size:12px}
      select,input[type="range"]{width: min(260px, 90vw)}
      #influence{max-width:220px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Color Coherence Lamp</h1>
      <div class="subtitle">PEAR-style feedback: recent RNG drift nudges the color</div>
    </header>

    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>End</button>
      </div>

      <div class="fsWrap">
        <div class="lamp" id="lamp"></div>
        <button id="fullscreenBtn" class="fsBtn ghost">Fullscreen</button>
      </div>

      <!-- Target controls stay visible for demos -->
      <div id="targetRow" class="targets">
        <span class="pill">Target color</span>
        <button class="target" data-hex="#FFFFFF" style="background:#ffffff;color:#111">White</button>
        <button class="target" data-hex="#FF0000" style="background:#ff0000">Red</button>
        <button class="target" data-hex="#FF7A00" style="background:#ff7a00">Orange</button>
        <button class="target" data-hex="#FFD400" style="background:#ffd400;color:#111">Yellow</button>
        <button class="target" data-hex="#00C853" style="background:#00c853">Green</button>
        <button class="target" data-hex="#00E5FF" style="background:#00e5ff;color:#111">Cyan</button>
        <button class="target" data-hex="#2962FF" style="background:#2962ff">Blue</button>
        <button class="target" data-hex="#7B1FA2" style="background:#7b1fa2">Purple</button>
        <button class="target" data-hex="#FF00AA" style="background:#ff00aa">Magenta</button>
        <button class="target" data-hex="" id="clearTarget">Clear</button>
      </div>

      <!-- Settings panel (hidden by default) -->
      <div class="settingsToggle">
        <button id="toggleSettings" class="ghost">Show settings</button>
      </div>
      <div id="settingsPanel" class="settingsPanel">
        <div class="ctl">
          <span class="pill">Mode</span>
          <select id="mode">
            <option value="discrete">MindLamp (Discrete colors)</option>
            <option value="continuous" selected>Rainbow (Continuous)</option>
          </select>

          <span class="pill">Sensitivity</span>
          <!-- slider 0..1 mapped internally to gain 0.5..8 -->
          <input id="gain" type="range" min="0" max="1" step="0.05" value="0.7"/>

          <span class="pill">Recent window</span>
          <select id="win">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
          </select>

          <span class="pill">Target influence</span>
          <select id="influence">
            <option value="off" selected>Off (pure Z)</option>
            <option value="gentle">Gentle</option>
            <option value="classic">Classic</option>
          </select>
        </div>
      </div>

      <div class="rowinfo">
        <span class="pill" id="status">Idle</span>
        <span class="pill" id="elapsed">Elapsed 00:00</span>
        <span class="pill" id="readout">Recent Z —</span>
        <span class="pill" id="hex">#000000</span>
      </div>

      <div class="muted">Defaults: Continuous mode, sensitivity 0.7, window 15. Pick a target anytime. “Target influence” lets you choose pure‑Z or a gentle/classic nudge.</div>
    </div>
  </div>

  <script>
  // =============== Math helpers ===============
  function erf(x){const s=x>=0?1:-1; x=Math.abs(x); const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911; const t=1/(1+p*x); const y=1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x); return s*y;}
  function cdfNormal(z){return .5*(1+erf(z/Math.SQRT2));}
  function stoufferZ(zs){if(!zs.length) return 0; const s=zs.reduce((a,b)=>a+b,0); return s/Math.sqrt(zs.length);}
  function twoSidedP(z){return 2*(1-cdfNormal(Math.abs(z)));}
  function clamp(v,a,b){return Math.max(a, Math.min(b, v));}
  function hsl(h,s,l){ return `hsl(${Math.round(h)}, ${Math.round(s)}%, ${Math.round(l)}%)`; }
  function hslToHex(h, s, l) {
    let r, g, b;
    if (s === 0) { r = g = b = l; }
    else {
      const hue2rgb=(p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1;
        if(t<1/6) return p+(q-p)*6*t;
        if(t<1/2) return q;
        if(t<2/3) return p+(q-p)*(2/3-t)*6;
        return p; };
      const q = l<0.5 ? l*(1+s) : l + s - l*s;
      const p = 2*l - q;
      r = hue2rgb(p,q,h+1/3);
      g = hue2rgb(p,q,h);
      b = hue2rgb(p,q,h-1/3);
    }
    const toHex=x=>Math.round(x*255).toString(16).padStart(2,'0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
  }

  function hexToRgb(hex){
    const h = hex.replace('#','');
    const bigint = parseInt(h, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return {r,g,b};
  }
  function rgbToHex(r,g,b){
    const to = v => Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0');
    return '#' + to(r) + to(g) + to(b);
  }
  function blendHex(a,b,t){
    const ra=hexToRgb(a), rb=hexToRgb(b);
    const r=ra.r + (rb.r-ra.r)*t, g=ra.g + (rb.g-ra.g)*t, b2=ra.b + (rb.b-ra.b)*t;
    return rgbToHex(r,g,b2).toUpperCase();
  }

  // =============== QRNG with fallback ===============
  async function qrng(len){
    try{
      const r = await fetch(`/.netlify/functions/qrng?len=${len}`, {mode:'cors'});
      if(!r.ok) throw new Error('qrng http '+r.status);
      const j = await r.json();
      const arr = j.data || [];
      if(arr.length) return new Uint16Array(arr.map(x=>x & 0xFFFF));
      throw new Error('qrng empty');
    }catch(e){
      const u16 = new Uint16Array(len);
      crypto.getRandomValues(u16);
      return u16;
    }
  }

  // =============== Engine ===============
  const Engine = {
    recent: [], ema:0, hasEma:false, t:0,
    win: 15,                      // window 15
    gain: 0.5 + 0.7 * 7.5,        // maps slider(0..1=0.7) -> ~5.75
    mode: 'continuous',           // default continuous
    palette: [
      '#FFFFFF', '#FF0000', '#FF7A00', '#FFD400',
      '#00C853', '#00E5FF', '#2962FF', '#7B1FA2', '#FF00AA'
    ],
    target: '',                   // hex or ''
    influence: 'off'              // 'off' | 'gentle' | 'classic'
  };

  function influenceAmounts() {
    if (Engine.influence === 'gentle')  return { cont: 0.12, disc: 0.25 };
    if (Engine.influence === 'classic') return { cont: 0.18, disc: 0.40 };
    return { cont: 0.0, disc: 0.0 };
  }

  function setLamp(hex){
    const el = document.getElementById('lamp');
    el.style.background = hex;
    el.style.boxShadow = `0 20px 80px rgba(0,0,0,.35) inset, 0 10px 30px rgba(255,255,255,.15)`;
    document.getElementById('hex').textContent = hex.toUpperCase();
  }

  function hueFromHex(hex){
    const {r,g,b} = hexToRgb(hex);
    const R=r/255, G=g/255, B=b/255;
    const max = Math.max(R,G,B), min = Math.min(R,G,B);
    let h=0, d=max-min;
    if (d===0) h=0;
    else if (max===R) h=( (G-B)/d )%6;
    else if (max===G) h=( (B-R)/d )+2;
    else h=( (R-G)/d )+4;
    h = Math.round(h*60); if (h<0) h+=360;
    return h;
  }

  function continuousColor(zRecent){
    const x = Math.tanh(Engine.gain * zRecent);
    let hue = ((x+1)/2)*360;
    const { cont } = influenceAmounts();
    if (Engine.target && cont > 0) {
      const th = hueFromHex(Engine.target);
      const diff = ((th - hue + 540)%360) - 180;
      hue += cont * diff;
    }
    const sat = 80, light=55;
    return hslToHex(hue/360, sat/100, light/100);
  }

  function discreteColor(zRecent){
    const x = Math.tanh(Engine.gain * zRecent);
    const t = (x+1)/2;
    const N = Engine.palette.length;
    const idx = t * N;
    const i0 = Math.floor(idx) % N;
    const i1 = (i0 + 1) % N;
    const frac = idx - Math.floor(idx);
    let c = blendHex(Engine.palette[i0], Engine.palette[i1], frac);
    const { disc } = influenceAmounts();
    if (Engine.target && disc > 0) {
      c = blendHex(c, Engine.target, disc);
    }
    return c;
  }

  function updateLampFromZ(zRecent){
    if(!Engine.hasEma){ Engine.ema = zRecent; Engine.hasEma = true; }
    Engine.ema = 0.75*Engine.ema + 0.25*zRecent;
    Engine.t += 0.012;
    const felt = Engine.ema + 0.04*Math.sin(Engine.t);

    const hex = (Engine.mode==='discrete') ? discreteColor(felt) : continuousColor(felt);
    setLamp(hex);
    document.getElementById('readout').textContent = `Recent Z ≈ ${zRecent.toFixed(2)} • p≈${twoSidedP(zRecent).toExponential(2)}`;
  }

  // =============== Session loop ===============
  let running=false, timer=null, t0=0;
  const statusEl = document.getElementById('status');
  const elapsedEl = document.getElementById('elapsed');

  function setStatus(txt){ statusEl.textContent = txt; }

  function startTimer(){
    t0 = Date.now();
    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      const ms=Date.now()-t0;
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000);
      elapsedEl.textContent = `Elapsed ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }, 250);
  }
  function stopTimer(){ if(timer) clearInterval(timer); timer=null; }

  async function tick(){
    try{
      const bitsPerTrial = 200;
      const words = Math.ceil(bitsPerTrial/16);
      const u16 = await qrng(words);
      const bits = [];
      for(let i=0;i<u16.length;i++){ let v=u16[i]; for(let b=0;b<16;b++){ bits.push((v>>b)&1); } }
      const trial = bits.slice(0,bitsPerTrial);
      const sum = trial.reduce((a,b)=>a+b,0);
      const n = bitsPerTrial, mu=n/2, sigma=Math.sqrt(n/4);
      const z = (sum - mu)/sigma;

      Engine.recent.push(z);
      while(Engine.recent.length > Engine.win) Engine.recent.shift();
      const recentZ = stoufferZ(Engine.recent);

      updateLampFromZ(recentZ);
      setStatus('Running…');
    }catch(e){
      setStatus('Load failed — retrying…');
    }
  }

  async function loop(){
    while(running){
      await tick();
      await new Promise(r=> setTimeout(r, 1000));
    }
  }

  // =============== Controls ===============
  // Settings toggle
  const settingsPanel = document.getElementById('settingsPanel');
  const toggleBtn = document.getElementById('toggleSettings');
  toggleBtn.addEventListener('click', ()=>{
    const open = settingsPanel.style.display === 'block';
    settingsPanel.style.display = open ? 'none' : 'block';
    toggleBtn.textContent = open ? 'Show settings' : 'Hide settings';
  });

  // Mode selector (default 'continuous')
  const modeSel = document.getElementById('mode');
  modeSel.value = 'continuous';
  modeSel.addEventListener('change', (e)=>{
    Engine.mode = e.target.value;
  });
  Engine.mode = 'continuous';

  // Sensitivity slider (0..1 => gain 0.5..8), default 0.7
  const gainEl = document.getElementById('gain');
  gainEl.value = '0.7';
  const mapGain = v => 0.5 + parseFloat(v)*7.5;
  Engine.gain = mapGain(gainEl.value);
  gainEl.addEventListener('input', (e)=>{
    Engine.gain = mapGain(e.target.value||'0.7');
  });

  // Window select (default 15)
  const winEl = document.getElementById('win');
  winEl.value = '15';
  Engine.win = parseInt(winEl.value,10);
  winEl.addEventListener('change', (e)=>{
    Engine.win = parseInt(e.target.value||'15',10);
    while(Engine.recent.length > Engine.win) Engine.recent.shift();
  });

  // Influence selector (default off)
  const inflEl = document.getElementById('influence');
  inflEl.value = 'off';
  Engine.influence = inflEl.value;
  inflEl.addEventListener('change', (e)=>{
    Engine.influence = e.target.value;
  });

  // Target color selection (kept visible)
  const targets = Array.from(document.querySelectorAll('.target'));
  targets.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      targets.forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      Engine.target = btn.dataset.hex || '';
    });
  });

  // Fullscreen toggle for lamp area
  document.getElementById('fullscreenBtn').addEventListener('click', async ()=>{
    const box = document.querySelector('.fsWrap');
    const isFs = document.fullscreenElement != null;
    try{
      if (!isFs) {
        await box.requestFullscreen();
        document.getElementById('fullscreenBtn').textContent = 'Exit Fullscreen';
      } else {
        await document.exitFullscreen();
        document.getElementById('fullscreenBtn').textContent = 'Fullscreen';
      }
    }catch(e){ /* ignore */ }
  });

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  startBtn.addEventListener('click', ()=>{
    if(running) return;
    running=true;
    startBtn.disabled=true; stopBtn.disabled=false;
    setStatus('Running…');
    startTimer();
    loop();
  });
  stopBtn.addEventListener('click', ()=>{
    running=false;
    startBtn.disabled=false; stopBtn.disabled=true;
    stopTimer();
    setStatus('Stopped');
  });

  // Prime lamp with a calm color
  setLamp('#0a1025');
  </script>
</body>
</html>
