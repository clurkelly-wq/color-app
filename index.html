<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QRNG Art Studio</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    :root{ --bg:#0b0f1a; --panel:#0f172a; --ink:#e5edff; --muted:#94a3b8; --accent:#38bdf8; --border:#1f2a44; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 36px}
    header{text-align:center;margin-bottom:10px}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    button{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border:none;color:#00111a;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer;font-size:15px}
    button.ghost{background:#0f1735;color:#cfe3ff;border:1px solid var(--border)}
    button:disabled{opacity:.6;cursor:not-allowed}
    select,input[type="range"]{background:#0e1020;border:1px solid var(--border);color:#e8ecff;border-radius:10px;padding:8px 10px}
    .pill{display:inline-block;border:1px solid var(--border);background:#0f1735;color:#cfe3ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .canvasWrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--border);box-shadow:inset 0 0 60px rgba(0,0,0,.25)}
    canvas{display:block;width:100%;height:auto;background:#050915}
    .status{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:10px}
    .bar{width:160px;height:8px;background:#0f1735;border-radius:20px;border:1px solid var(--border);overflow:hidden}
    .bar>i{display:block;height:100%;width:10%;background:#38bdf8}
    .note{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}
    @media (max-width:640px){
      .wrap{padding:14px 10px 30px}
      button{font-size:14px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>QRNG Art Studio</h1>
      <div class="sub">Generative art steered by a quantum random source (with graceful offline fallback)</div>
    </header>

    <div class="panel" style="margin-bottom:10px">
      <div class="row" style="margin-bottom:8px">
        <button id="genBtn">Generate</button>
        <button id="animBtn" class="ghost">Animate</button>
        <button id="saveBtn" class="ghost">Save PNG</button>
        <button id="fsBtn" class="ghost">Fullscreen</button>

        <span class="pill">Style</span>
        <select id="style">
          <option value="aurora" selected>Aurora Veils</option>
          <option value="spirals">Sacred Spirals</option>
          <option value="constellations">Constellation Field</option>
          <option value="mondrian">Quantum Mondrian</option>
          <option value="pointillism">Pointillist Bloom</option>
        </select>

        <span class="pill">Detail</span>
        <input id="detail" type="range" min="0.5" max="2.0" value="1.0" step="0.1"/>
      </div>

      <div class="row">
        <span class="pill" id="statusPill">QRNG: connecting…</span>
        <span class="pill" id="seedPill">Seed —</span>
        <span class="pill" id="sizePill">Canvas —</span>
        <span class="bar"><i id="entropyFill" style="width:10%"></i></span>
      </div>
      <div class="note">Tip: click “Animate” for a living piece. “Generate” makes a fresh still using new quantum entropy.</div>
    </div>

    <div class="canvasWrap">
      <canvas id="c"></canvas>
    </div>

    <div class="note">Made with love for Clare — where intention meets emergence ✨</div>
  </div>

  <script>
  const QRNG = {
    buf: new Uint16Array(0), i: 0, online: false, fetching: false, statusEl: null, entropyEl: null,
    async topUp(target=2048){
      if(this.fetching) return;
      if(this.buf.length - this.i > target/4) return;
      this.fetching = true;
      try{
        const r = await fetch(`/.netlify/functions/qrng?len=${target}`, {mode:'cors'});
        if(!r.ok) throw new Error('http '+r.status);
        const j = await r.json();
        const arr = (j && Array.isArray(j.data)) ? j.data : [];
        if(!arr.length) throw new Error('empty');
        const more = new Uint16Array(arr.map(x=>x & 0xFFFF));
        if(this.i >= this.buf.length){ this.buf = more; this.i = 0; }
        else{
          const remain = this.buf.slice(this.i);
          this.buf = new Uint16Array(remain.length + more.length);
          this.buf.set(remain,0); this.buf.set(more,remain.length); this.i = 0;
        }
        this.online = true; this.setStatus('QRNG online');
      }catch(e){
        const more = new Uint16Array(target); crypto.getRandomValues(more);
        if(this.i >= this.buf.length){ this.buf = more; this.i = 0; }
        else{
          const remain = this.buf.slice(this.i);
          this.buf = new Uint16Array(remain.length + more.length);
          this.buf.set(remain,0); this.buf.set(more,remain.length); this.i = 0;
        }
        if(!this.online) this.setStatus('Using local RNG (offline)');
      }finally{ this.fetching=false; this.updateEntropy(); }
    },
    need(n){ if(this.buf.length - this.i < n) return this.topUp(Math.max(2048, n*2)); },
    u16(){ if(this.i >= this.buf.length){ this.topUp(); return (Math.random()*65536)|0; } const v=this.buf[this.i++]; this.updateEntropy(); return v; },
    f32(){ return this.u16() / 65535; },
    setStatus(msg){ if(this.statusEl) this.statusEl.textContent = msg; },
    updateEntropy(){ if(!this.entropyEl) return; const remain = Math.max(0, this.buf.length - this.i); const ratio = Math.max(0.02, Math.min(1, remain / Math.max(1,this.buf.length))); this.entropyEl.style.width = (ratio*100).toFixed(0)+'%'; }
  };

  const canvas = document.getElementById('c'); const ctx = canvas.getContext('2d');
  function resize(){ const rect = canvas.parentElement.getBoundingClientRect(); const w = Math.max(640, Math.floor(rect.width)); const h = Math.floor(w*9/16); canvas.width=w*2; canvas.height=h*2; canvas.style.height=h+'px'; canvas.style.width=w+'px'; document.getElementById('sizePill').textContent=`Canvas — ${w}×${h}`; }
  window.addEventListener('resize', resize); resize();

  function rand(){ return QRNG.f32(); }
  function rint(a,b){ return Math.floor(a + rand()*(b-a+1)); }
  function choice(arr){ return arr[rint(0, arr.length-1)]; }
  function gauss(){ let u=0,v=0; while(u===0) u=rand(); while(v===0) v=rand(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }

  const PALETTES = [
    ['#0ea5e9','#22d3ee','#a78bfa','#f472b6','#f59e0b'],
    ['#ff5d73','#ffd166','#06d6a0','#118ab2','#073b4c'],
    ['#fde68a','#fca5a5','#93c5fd','#34d399','#fbb6ce'],
    ['#ffffff','#9fb3ff','#7ee0ff','#a0ffd6','#ffe29f'],
    ['#ff5f6d','#ffc371','#00c6ff','#0072ff','#48c6ef']
  ];

  function clear(bg='#050915'){ ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height); }

  function starfield(n=60, alpha=0.6){
    ctx.save(); ctx.globalAlpha=alpha;
    for(let i=0;i<n;i++){ const x=rand()*canvas.width, y=rand()*canvas.height, s=Math.pow(rand(),2)*3+0.6; ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }
  function glow(strength=1){ ctx.globalCompositeOperation='lighter'; ctx.filter='blur('+2*strength+'px)'; ctx.drawImage(canvas,0,0); ctx.filter='none'; ctx.globalCompositeOperation='source-over'; }

  function auroraVeils(detail=1){
    clear('#040713'); const layers=Math.round(6*detail);
    for(let i=0;i<layers;i++){ const hue=rint(180,340); const alpha=0.06+0.06*rand(); const y0=canvas.height*(0.1+0.8*rand()); const amp=canvas.height*(0.08+0.2*rand()); const wig=2+6*rand(); const width=canvas.width*(0.5+rand()*0.6); const x0=canvas.width*rand(); ctx.fillStyle='hsla('+hue+',90%,60%,'+alpha.toFixed(3)+')'; ctx.beginPath(); ctx.moveTo(x0-width/2,y0); const steps=20+Math.floor(120*detail); for(let s=0;s<=steps;s++){ const t=s/steps; const x=x0-width/2+width*t; const y=y0+Math.sin(t*Math.PI*wig+rand()*0.5)*amp*(0.6+0.4*rand()); ctx.lineTo(x,y);} ctx.lineTo(x0+width/2,canvas.height+10); ctx.lineTo(x0-width/2,canvas.height+10); ctx.closePath(); ctx.filter='blur('+(2+4*rand())+'px)'; ctx.fill(); ctx.filter='none'; }
    starfield(60*detail,0.6);
  }

  function sacredSpirals(detail=1){
    clear('#030510'); const palette=choice(PALETTES); const arms=2+rint(0,4); const centers=1+rint(0,2);
    for(let c=0;c<centers;c++){ const cx=canvas.width*(0.3+0.4*rand()); const cy=canvas.height*(0.35+0.3*rand()); const base=canvas.width*(0.004+0.01*rand());
      for(let a=0;a<arms;a++){ const rot=(2*Math.PI*a/arms)+rand()*0.5; const points=400+Math.floor(600*detail); const growth=1.005+0.003*rand(); let r=base*(0.5+rand()); ctx.lineWidth=1+2*rand(); ctx.strokeStyle=choice(palette); ctx.globalAlpha=0.6; ctx.beginPath(); for(let i=0;i<points;i++){ const th=rot+i*0.08; const x=cx+Math.cos(th)*r; const y=cy+Math.sin(th)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); r*=growth; } ctx.stroke(); ctx.globalAlpha=1; }
    } glow();
  }

  function constellationField(detail=1){
    clear('#050a18'); const stars=200+Math.floor(300*detail); const pts=[];
    for(let i=0;i<stars;i++){ const x=rand()*canvas.width, y=rand()*canvas.height; const s=Math.pow(rand(),2)*3+0.5; pts.push({x,y,s}); ctx.fillStyle='rgba(255,255,255,'+(0.3+0.7*rand())+')'; ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill(); if(rand()<0.25){ ctx.fillStyle=choice(['#8ab6ff','#ffd18a','#bbf7d0']); ctx.beginPath(); ctx.arc(x,y,s*0.6,0,Math.PI*2); ctx.fill(); } }
    const links=Math.round(150*detail); ctx.strokeStyle='rgba(120,180,255,0.25)';
    for(let i=0;i<links;i++){ const a=pts[rint(0,pts.length-1)], b=pts[rint(0,pts.length-1)]; ctx.lineWidth=0.5+rand(); ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
    glow(1.5);
  }

  function mondrian(detail=1){
    clear('#101318'); const rect={x:0,y:0,w:canvas.width,h:canvas.height}; const palette=['#fefefe','#e63946','#457b9d','#f1fa8c','#2a9d8f'];
    function split(r,depth){ const min=120/detail; if(depth>5 || r.w<min || r.h<min || rand()<0.2){ ctx.fillStyle=(rand()<0.7)? '#0f172a' : palette[rint(0,palette.length-1)]; ctx.fillRect(r.x+2,r.y+2,r.w-4,r.h-4); ctx.strokeStyle='#0d1328'; ctx.lineWidth=6; ctx.strokeRect(r.x+3,r.y+3,r.w-6,r.h-6); return; }
      const vertical = rand()<0.5; if(vertical){ const cut=r.x+r.w*(0.3+0.4*rand()); split({x:r.x,y:r.y,w:cut-r.x,h:r.h},depth+1); split({x:cut,y:r.y,w:r.x+r.w-cut,h:r.h},depth+1); } else { const cut=r.y+r.h*(0.3+0.4*rand()); split({x:r.x,y:r.y,w:r.w,h:cut-r.y},depth+1); split({x:r.x,y:cut,w:r.w,h:r.y+r.h-cut},depth+1); } }
    split(rect,0);
  }

  function pointillism(detail=1){
    clear('#0a0f1e'); const palette=choice(PALETTES); const dots=1200+Math.floor(1800*detail);
    for(let i=0;i<dots;i++){ const x=rand()*canvas.width, y=rand()*canvas.height; const s=Math.pow(rand(),2.2)*6+0.6; const c=palette[rint(0,palette.length-1)]; ctx.fillStyle=c; ctx.globalAlpha=0.35+0.6*rand(); ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill(); }
    ctx.globalAlpha=1; glow(1.2);
  }

  function seedFromQRNG(){ const a=[QRNG.u16(),QRNG.u16(),QRNG.u16(),QRNG.u16()]; document.getElementById('seedPill').textContent='Seed '+a.map(x=>x.toString(16).padStart(4,'0')).join('-'); }
  function renderOnce(){ const detail=parseFloat(document.getElementById('detail').value||'1'); const style=document.getElementById('style').value; QRNG.need(4096); seedFromQRNG(); if(style==='aurora') auroraVeils(detail); else if(style==='spirals') sacredSpirals(detail); else if(style==='constellations') constellationField(detail); else if(style==='mondrian') mondrian(detail); else pointillism(detail); }

  let anim=false, raf=0;
  function tickAnim(){ if(!anim) return; const style=document.getElementById('style').value; const d=parseFloat(document.getElementById('detail').value||'1'); if(style==='aurora'){ auroraVeils(0.4*d);} else if(style==='spirals'){ sacredSpirals(0.6*d);} else if(style==='constellations'){ constellationField(0.5*d);} else if(style==='mondrian'){ mondrian(0.8*d);} else { pointillism(0.6*d);} raf=requestAnimationFrame(tickAnim); }

  document.getElementById('genBtn').addEventListener('click', renderOnce);
  document.getElementById('animBtn').addEventListener('click', (e)=>{ anim=!anim; e.target.textContent=anim?'Stop':'Animate'; if(anim){ tickAnim(); } else { cancelAnimationFrame(raf); } });
  document.getElementById('saveBtn').addEventListener('click', ()=>{ const a=document.createElement('a'); a.download='qrng-art-'+Date.now()+'.png'; a.href=canvas.toDataURL('image/png'); a.click(); });
  document.getElementById('fsBtn').addEventListener('click', async()=>{ const box=document.querySelector('.canvasWrap'); const isFs=document.fullscreenElement!=null; try{ if(!isFs){ await box.requestFullscreen(); } else { await document.exitFullscreen(); } }catch(e){} });

  QRNG.statusEl=document.getElementById('statusPill'); QRNG.entropyEl=document.getElementById('entropyFill'); QRNG.topUp(4096).then(()=> renderOnce());
  </script>
</body>
</html>
